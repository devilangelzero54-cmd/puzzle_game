<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>めいっ狐スライドパズル - 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: url("images/title_bg.png") center/cover no-repeat fixed;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #fff;
    }

    .wrapper {
      width: 100%;
      max-width: 420px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.45);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      text-align: center;
    }

    .game-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 12px;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
    }

    .board {
      width: 260px;
      height: 260px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 2px;
      background: #444;
      padding: 2px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      touch-action: manipulation;
      margin: 0 auto 12px;
    }

    .tile {
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      border-radius: 4px;
      cursor: pointer;
    }

    .tile.blank {
      background: #333;
      cursor: default;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .controls button,
    #nextBtn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #ffd35a;
      color: #333;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    .controls button:active,
    #nextBtn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }

    #nextBtn {
      display: none; /* クリアするまで非表示 */
      margin-bottom: 8px;
      background: #5ac8ff;
      color: #053148;
    }

    .info {
      font-size: 13px;
      margin-bottom: 6px;
      text-shadow: 0 1px 4px rgba(0, 0, 0, 0.6);
    }

    .credit {
      font-size: 11px;
      opacity: 0.9;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1 class="game-title">めいっ狐スライドパズル 1</h1>

    <!-- パズル本体 -->
    <div id="board" class="board"></div>

    <div class="controls">
      <button id="shuffleBtn">シャッフル</button>
      <button id="resetBtn">リセット</button>
    </div>

    <!-- クリアしたら出てくるボタン -->
    <button id="nextBtn">つぎのパズルへ</button>

    <div class="info" id="infoText">
      タイルをスワイプ感覚でタップして動かしてね。
    </div>

    <div class="credit">
      © 2025 Tommy / Images: PixAI(Haruka V2) / Code: ChatGPT
    </div>
  </div>

  <script>
    const SIZE = 4;          // 4×4
    const BLANK_ID = 16;     // 16番を空白扱い
    const boardEl  = document.getElementById("board");
    const infoText = document.getElementById("infoText");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const resetBtn   = document.getElementById("resetBtn");
    const nextBtn    = document.getElementById("nextBtn");

    // 現在の並び（1〜16）を持つ配列
    let tiles = [];

    // 画像パスを返す（番号 → ファイル名）
    function getImagePath(id) {
      if (id === BLANK_ID) {
        return "images/kuhaku.png";
      }
      // 1 → puzzle1_001.jpg, 2 → puzzle1_002.jpg … という前提
      const num = String(id).padStart(3, "0");
      return `images/puzzle1_${num}.jpg`;
    }

    // 盤面をHTMLに描画
    function render() {
      boardEl.innerHTML = "";

      tiles.forEach((id, index) => {
        const tile = document.createElement("div");
        tile.className = "tile";

        if (id === BLANK_ID) {
          tile.classList.add("blank");
        } else {
          tile.style.backgroundImage = `url(${getImagePath(id)})`;
        }

        tile.dataset.index = index;
        tile.addEventListener("click", onTileClick);
        boardEl.appendChild(tile);
      });
    }

    // タップしたタイルの処理
    function onTileClick(e) {
      const index      = Number(e.currentTarget.dataset.index);
      const blankIndex = tiles.indexOf(BLANK_ID);

      if (!isAdjacent(index, blankIndex)) return;

      // タップしたタイルと空白を入れ替え
      [tiles[index], tiles[blankIndex]] = [tiles[blankIndex], tiles[index]];
      render();

      if (isSolved()) {
        infoText.textContent = "完成！おめでとう！";
        if (nextBtn) {
          nextBtn.style.display = "inline-block"; // 次へボタンを表示
        }
      }
    }

    // 隣接しているかどうか
    function isAdjacent(i1, i2) {
      const r1 = Math.floor(i1 / SIZE);
      const c1 = i1 % SIZE;
      const r2 = Math.floor(i2 / SIZE);
      const c2 = i2 % SIZE;
      const dr = Math.abs(r1 - r2);
      const dc = Math.abs(c1 - c2);
      return (dr + dc === 1);
    }

    // クリア判定
    function isSolved() {
      for (let i = 0; i < SIZE * SIZE - 1; i++) {
        if (tiles[i] !== i + 1) return false;
      }
      return true;
    }

    // シャッフル（解ける並びだけ許可）
    function shuffleTiles() {
      const arr = [];
      for (let i = 1; i < BLANK_ID; i++) {
        arr.push(i);
      }

      do {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        tiles = arr.concat(BLANK_ID);
      } while (!isSolvable(arr));
    }

    // 反転数で解ける並びかどうか判定
    function isSolvable(arr) {
      let inv = 0;
      for (let i = 0; i < arr.length; i++) {
        for (let j = i + 1; j < arr.length; j++) {
          if (arr[i] > arr[j]) inv++;
        }
      }
      return inv % 2 === 0;
    }

    // まっさらな完成状態に戻す
    function resetTiles() {
      tiles = [];
      for (let i = 1; i <= SIZE * SIZE; i++) {
        tiles.push(i);
      }
    }

    // 初期化
    function init() {
      resetTiles();
      render();
      infoText.textContent = "シャッフルして遊んでみてね。";
      if (nextBtn) {
        nextBtn.style.display = "none";
      }

      shuffleBtn.addEventListener("click", () => {
        shuffleTiles();
        render();
        infoText.textContent = "シャッフル完了！ そろえてみてね。";
        if (nextBtn) nextBtn.style.display = "none";
      });

      resetBtn.addEventListener("click", () => {
        resetTiles();
        render();
        infoText.textContent = "リセットしたよ。もう一度そろえてみてね。";
        if (nextBtn) nextBtn.style.display = "none";
      });

      nextBtn.addEventListener("click", () => {
        // 2枚目のパズルへ
        location.href = "puzzle2.html";
      });
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
